<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR CCCD Scanner</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- jsQR Library -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  
  <style>
    body {
      background: linear-gradient(180deg,#0f172a,#07103a);
      color: #e6eef8;
      min-height: 100vh;
    }
    
    /* Overlay styles */
    .camera-overlay {
      position: relative;
      width: 100%;
      height: 400px;
      overflow: hidden;
      border-radius: 12px;
      background: #000;
    }
    
    .scan-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(2.5);
      width: 120px;
      height: 120px;
      border: 3px solid #10b981;
      border-radius: 8px;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8);
      z-index: 10;
      pointer-events: none;
    }
    
    .scan-frame::before {
      content: "";
      position: absolute;
      top: -40px;
      left: 0;
      width: 100%;
      color: #10b981;
      font-size: 14px;
      text-align: center;
      font-weight: 500;
    }
    
    .scan-frame::after {
      content: "";
      position: absolute;
      top: 5px;
      left: 5px;
      right: 5px;
      bottom: 5px;
      border: 2px dashed rgba(16, 185, 129, 0.6);
      border-radius: 4px;
      pointer-events: none;
    }
    
    #videoElement {
      width: 100%;
      height: 100%;
      object-fit: cover;
      /* Zoom x2 bằng CSS transform */
      transform: scale(2);
      transform-origin: center;
    }
    
    .capture-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 280px;
      height: 180px;
      border: 3px solid #f59e0b;
      border-radius: 8px;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
      z-index: 10;
      pointer-events: none;
    }
    
    .capture-frame::before {
      content: "";
      position: absolute;
      top: -35px;
      left: 0;
      width: 100%;
      color: #f59e0b;
      font-size: 14px;
      text-align: center;
      font-weight: 500;
    }
    
    .hidden {
      display: none !important;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      backdrop-filter: blur(10px);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      border: none;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      transition: all 0.3s ease;
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      border: none;
      transition: all 0.3s ease;
    }
    
    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: none;
      transition: all 0.3s ease;
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3);
    }
    @keyframes scanLine {
      0% { top: 10%; }
      100% { top: 90%; }
    }

    .scan-frame::after {
      content: "";
      position: absolute;
      top: 10%;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, #10b981, transparent);
      animation: scanLine 2s ease-in-out infinite;
      z-index: 11;
    }

    @keyframes pulse {
      0% { transform: scale(0.5); opacity: 1; }
      100% { transform: scale(2); opacity: 0; }
    }
  </style>
</head>
<body class="p-4">
  <!-- Header -->
  <header class="mb-6">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold text-white">QR CCCD Scanner</h1>
        <p class="text-slate-400">Chào mừng, <span class="font-medium text-blue-400">{{ username }}</span></p>
      </div>
      <button id="btn-logout" class="px-4 py-2 btn-danger rounded-lg">
        Đăng xuất
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left Panel - Menu -->
    <div class="lg:col-span-1">
      <div class="card p-6">
        <h2 class="text-xl font-semibold text-white mb-4">Chức năng</h2>
        <div class="space-y-3">
          <button id="btn-scan-qr" class="w-full py-3 btn-primary rounded-lg">
            <div class="flex items-center justify-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
              </svg>
              Quét QR CCCD
            </div>
          </button>
          
          <button id="btn-view-records" class="w-full py-3 btn-success rounded-lg">
            <div class="flex items-center justify-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
              Xem danh sách
            </div>
          </button>
          
          <div class="pt-4 mt-4 border-t border-slate-700">
            <h3 class="text-sm font-medium text-slate-300 mb-2">Hướng dẫn</h3>
            <ul class="text-sm text-slate-400 space-y-2">
              <li class="flex items-start">
                <span class="inline-block w-2 h-2 bg-blue-500 rounded-full mt-1 mr-2"></span>
                Chọn "Quét QR CCCD" để bắt đầu quét
              </li>
              <li class="flex items-start">
                <span class="inline-block w-2 h-2 bg-green-500 rounded-full mt-1 mr-2"></span>
                Đưa QR code vào khung xanh để quét
              </li>
              <li class="flex items-start">
                <span class="inline-block w-2 h-2 bg-amber-500 rounded-full mt-1 mr-2"></span>
                Sau khi quét QR, chụp ảnh CCCD vào khung cam
              </li>
              <li class="flex items-start">
                <span class="inline-block w-2 h-2 bg-purple-500 rounded-full mt-1 mr-2"></span>
                Nhập số điện thoại trước khi lưu
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel - Content -->
    <div class="lg:col-span-2">
      <!-- QR Scanning Section -->
      <div id="scan-section" class="hidden">
        <div class="card p-6">
          <h2 class="text-xl font-semibold text-white mb-4">Quét QR CCCD</h2>
          
          <div id="camera-check" class="mb-4 p-4 bg-yellow-900/30 text-yellow-300 rounded-lg hidden">
            <p class="font-semibold">⚠️ Yêu cầu quyền truy cập camera</p>
            <p class="text-sm mt-1">Vui lòng cho phép truy cập camera để sử dụng tính năng quét QR</p>
            <button id="btn-enable-camera" class="mt-2 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg">
              Cho phép camera
            </button>
          </div>
          
          <div class="camera-overlay mb-4">
            <video id="videoElement" autoplay playsinline></video>
            <div class="scan-frame"></div>
          </div>
          
          <div id="qr-info" class="text-sm text-slate-200"></div>
          
          <!-- Nút chuyển camera -->
          <div class="mt-4 text-center">
            <button id="btn-switch-camera" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors text-sm">
              Chuyển camera
            </button>
          </div>
        </div>
      </div>

      <!-- Capture Section -->
      <div id="capture-section" class="hidden">
        <div class="card p-6">
          <h2 class="text-xl font-semibold text-white mb-4">Chụp ảnh CCCD</h2>
          
          <div class="mb-6">
            <div id="qr-data" class="bg-slate-800 p-4 rounded-lg"></div>
          </div>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Camera Capture -->
            <div>
              <div class="camera-overlay h-64 mb-4">
                <video id="video" autoplay playsinline class="w-full h-full object-cover" style="transform: scale(1.5); transform-origin: center;"></video>
                <div class="capture-frame"></div>
              </div>
              
              <div class="grid grid-cols-2 gap-3">
                <button id="btn-front" class="py-3 btn-warning rounded-lg">
                  Chụp mặt trước
                </button>
                <button id="btn-back" class="py-3 btn-danger rounded-lg">
                  Chụp mặt sau
                </button>
              </div>
            </div>
            
            <!-- Image Previews -->
            <div class="space-y-4">
              <div>
                <h3 class="text-sm font-medium text-slate-300 mb-2">Ảnh mặt trước</h3>
                <img id="preview-front" class="w-full h-40 bg-slate-800 rounded-lg object-contain border border-slate-700">
              </div>
              
              <div>
                <h3 class="text-sm font-medium text-slate-300 mb-2">Ảnh mặt sau</h3>
                <img id="preview-back" class="w-full h-40 bg-slate-800 rounded-lg object-contain border border-slate-700">
              </div>
            </div>
          </div>
          
          <!-- Phone Input -->
          <div class="mt-6">
            <label class="block text-sm font-medium text-slate-300 mb-2">Số điện thoại</label>
            <input id="input-phone" type="tel" 
                   class="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="Nhập số điện thoại (bắt buộc)">
            <p class="text-xs text-slate-400 mt-1">Ví dụ: 0912345678</p>
          </div>
          
          <!-- Action Buttons -->
          <div class="flex gap-3 mt-6">
            <button id="btn-save-info" class="flex-1 py-3 btn-success rounded-lg">
              Lưu thông tin
            </button>
            <button id="btn-reset" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors">
              Làm lại
            </button>
          </div>
          
          <p id="save-status" class="mt-4 text-center text-sm"></p>
        </div>
      </div>

      <!-- View Records Section -->
      <div id="view-section" class="hidden">
        <div class="card p-6">
          <h2 class="text-xl font-semibold text-white mb-4">Danh sách bản ghi</h2>
          
          <div class="mb-6">
            <div class="flex gap-3">
              <input id="view-username" 
                     class="flex-1 p-3 rounded-lg bg-slate-800 border border-slate-700 text-white"
                     placeholder="Nhập username..." value="{{ username }}">
              <button id="btn-load-records" class="px-6 py-3 btn-primary rounded-lg">
                Tải dữ liệu
              </button>
            </div>
          </div>
          
          <div id="records-area" class="text-sm text-slate-200"></div>
          
          <div id="records-stats" class="mt-4 text-center text-slate-400"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    let currentUser = "{{ username }}";
    let parsedQR = null;
    let frontImg = null;
    let backImg = null;
    let stream = null;
    let qrStream = null;
    let isProcessingQR = false;
    let currentCamera = 'environment';
    let isCameraAvailable = false;
    let scanningActive = false;
    let canvas = null;
    let canvasContext = null;
    let scanRetryCount = 0;
    const MAX_RETRIES = 3;
    let debugMode = false;

    // ---------------------
    // KIỂM TRA VÀ CẤU HÌNH CAMERA
    // ---------------------
    // Kiểm tra xem trình duyệt có hỗ trợ getUserMedia không
    function checkCameraSupport() {
      // Kiểm tra các phiên bản khác nhau của getUserMedia
      navigator.getUserMedia = navigator.getUserMedia || 
                               navigator.webkitGetUserMedia || 
                               navigator.mozGetUserMedia || 
                               navigator.msGetUserMedia;
      
      // Tạo mediaDevices nếu chưa có
      if (!navigator.mediaDevices) {
        navigator.mediaDevices = {};
      }
      
      // Thêm getUserMedia vào mediaDevices nếu chưa có
      if (!navigator.mediaDevices.getUserMedia) {
        if (navigator.getUserMedia) {
          navigator.mediaDevices.getUserMedia = function(constraints) {
            return new Promise(function(resolve, reject) {
              navigator.getUserMedia(constraints, resolve, reject);
            });
          };
        } else {
          return false;
        }
      }
      
      return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
    }

    // Hiển thị thông báo yêu cầu quyền camera
    function showCameraPermissionRequest() {
      document.getElementById('camera-check').classList.remove('hidden');
    }

    // Ẩn thông báo yêu cầu quyền camera
    function hideCameraPermissionRequest() {
      document.getElementById('camera-check').classList.add('hidden');
    }

    // Khởi tạo kiểm tra camera khi trang tải
    document.addEventListener('DOMContentLoaded', function() {
      isCameraAvailable = checkCameraSupport();
      
      if (!isCameraAvailable) {
        showCameraPermissionRequest();
        document.getElementById('btn-scan-qr').disabled = true;
        document.getElementById('btn-scan-qr').innerHTML = 
          '<div class="flex items-center justify-center opacity-50">' +
          '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
          '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>' +
          '</svg>Camera không khả dụng</div>';
      } else {
        // Khởi tạo canvas cho jsQR
        canvas = document.createElement('canvas');
        canvasContext = canvas.getContext('2d', { willReadFrequently: true });
      }
    });

    // Sự kiện cho nút bật camera
    document.getElementById('btn-enable-camera').onclick = function() {
      alert("Vui lòng kiểm tra:\n1. Trang web đang chạy trên HTTPS hoặc localhost\n2. Đã cho phép quyền camera trong trình duyệt\n3. Trình duyệt hỗ trợ WebRTC (Chrome, Firefox, Edge, Safari)");
      location.reload();
    };

    // ---------------------
    // LOGOUT
    // ---------------------
    document.getElementById('btn-logout').onclick = () => {
      if (confirm('Bạn có chắc muốn đăng xuất?')) {
        window.location.href = '/logout';
      }
    };

    // ---------------------
    // MENU NAVIGATION
    // ---------------------
    document.getElementById('btn-scan-qr').onclick = () => {
      if (!isCameraAvailable) {
        showCameraPermissionRequest();
        return;
      }
      
      showSection('scan-section');
      startQRScanner();
    };

    document.getElementById('btn-view-records').onclick = () => {
      showSection('view-section');
      stopAllCameras();
      loadRecords(currentUser);
    };

    function showSection(sectionId) {
      // Hide all sections
      document.getElementById('scan-section').classList.add('hidden');
      document.getElementById('capture-section').classList.add('hidden');
      document.getElementById('view-section').classList.add('hidden');
      
      // Show selected section
      document.getElementById(sectionId).classList.remove('hidden');
      
      // Stop cameras if not in scan section
      if (sectionId !== 'scan-section') {
        stopQRScanner();
      }
      if (sectionId !== 'scan-section' && sectionId !== 'capture-section') {
        stopCaptureCamera();
      }
    }

    // ---------------------
    // QR SCANNER using jsQR
    // ---------------------
    async function startQRScanner() {
      try {
        // Clear previous error messages
        document.getElementById('qr-info').innerHTML = '';
        
        // Hiển thị thông báo đang khởi động
        document.getElementById('qr-info').innerHTML = 
          '<div class="p-4 bg-blue-900/30 text-blue-300 rounded-lg">⏳ Đang khởi động camera với zoom 2x...</div>';
        
        // Dừng scanner cũ nếu có
        stopQRScanner();
        
        // Lấy stream camera với constraints tối ưu
        const constraints = {
          video: {
            facingMode: currentCamera,
            width: { ideal: 1920, min: 1280 },  // Tăng độ phân giải
            height: { ideal: 1080, min: 720 },
            frameRate: { ideal: 60, min: 30 },  // Tăng FPS
            aspectRatio: { ideal: 1.777 },      // 16:9
            focusMode: ['continuous', 'single-shot'] // Tự động lấy nét
          },
          audio: false
        };
        
        // Thử bắt đầu camera
        try {
          qrStream = await navigator.mediaDevices.getUserMedia(constraints);
        } catch (err) {
          console.error("Camera error:", err);
          
          // Thử lại với constraints đơn giản hơn
          const simpleConstraints = {
            video: true,
            audio: false
          };
          
          qrStream = await navigator.mediaDevices.getUserMedia(simpleConstraints);
        }
        
        const videoElement = document.getElementById('videoElement');
        videoElement.srcObject = qrStream;
        
        // Đợi video sẵn sàng
        await new Promise((resolve) => {
          if (videoElement.readyState >= 3) { // HAVE_FUTURE_DATA
            resolve();
          } else {
            videoElement.onloadeddata = () => {
              resolve();
            };
            // Timeout sau 3 giây
            setTimeout(resolve, 3000);
          }
        });
        
        // Áp dụng zoom CSS
        videoElement.style.transform = 'scale(2)';
        videoElement.style.transformOrigin = 'center';
        
        console.log("Bắt đầu quét QR với jsQR (tối ưu)...");
        
        // Bắt đầu quét
        scanningActive = true;
        scanRetryCount = 0; // Reset retry count
        scanQRCode();
        
        document.getElementById('qr-info').innerHTML = 
          '<div class="p-4 bg-blue-900/30 text-blue-300 rounded-lg">✅ Camera đã sẵn sàng (Zoom 2x). Đưa QR code CCCD vào khung xanh.</div>';
        
        hideCameraPermissionRequest();
        
        // Thêm event listener cho tap-to-focus
        videoElement.addEventListener('click', handleTapToFocus);
        
      } catch (error) {
        console.error("Failed to start QR scanner:", error);
        showQRScanError(`Lỗi khởi động camera: ${error.message}. Vui lòng kiểm tra quyền camera.`, true);
        showCameraPermissionRequest();
      }
    }

    // Hàm xử lý tap-to-focus
    async function handleTapToFocus(e) {
      if (!qrStream) return;
      
      const video = e.target;
      const rect = video.getBoundingClientRect();
      
      // Tính toán tọa độ tap
      const x = (e.clientX - rect.left) / rect.width;
      const y = (e.clientY - rect.top) / rect.height;
      
      const track = qrStream.getVideoTracks()[0];
      if (track && track.getCapabilities && track.getCapabilities().focusDistance) {
        try {
          await track.applyConstraints({
            advanced: [{
              focusMode: 'manual',
              focusDistance: 0.2 // Tập trung vào điểm tap
            }]
          });
          
          // Hiển thị feedback
          showTapFeedback(e.clientX, e.clientY);
        } catch (err) {
          console.error("Focus error:", err);
        }
      }
    }

    // Hiển thị feedback khi tap
    function showTapFeedback(x, y) {
      const feedback = document.createElement('div');
      feedback.style.position = 'fixed';
      feedback.style.left = x + 'px';
      feedback.style.top = y + 'px';
      feedback.style.width = '50px';
      feedback.style.height = '50px';
      feedback.style.border = '2px solid #3b82f6';
      feedback.style.borderRadius = '50%';
      feedback.style.pointerEvents = 'none';
      feedback.style.zIndex = '1000';
      feedback.style.animation = 'pulse 1s ease-out';
      
      document.body.appendChild(feedback);
      setTimeout(() => feedback.remove(), 1000);
    }

    // Hàm quét QR code sử dụng jsQR với zoom số và xử lý ảnh
    function scanQRCode() {
      if (!scanningActive || !qrStream) return;
      
      const videoElement = document.getElementById('videoElement');
      
      if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
        // Cập nhật kích thước canvas
        canvas.width = videoElement.videoWidth;
        canvas.height = videoElement.videoHeight;
        
        // Áp dụng zoom số bằng cách crop và scale
        const zoomFactor = 2.0; // Zoom x2
        
        // Tính toán vùng crop (trung tâm, zoom 2x)
        const cropWidth = canvas.width / zoomFactor;
        const cropHeight = canvas.height / zoomFactor;
        const cropX = (canvas.width - cropWidth) / 2;
        const cropY = (canvas.height - cropHeight) / 2;
        
        // Vẽ frame video với crop zoom
        canvasContext.save();
        canvasContext.translate(-cropX, -cropY);
        canvasContext.scale(zoomFactor, zoomFactor);
        canvasContext.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
        canvasContext.restore();
        
        // Lấy dữ liệu hình ảnh từ vùng zoom
        const imageData = canvasContext.getImageData(
          canvas.width/2 - cropWidth/2, 
          canvas.height/2 - cropHeight/2, 
          cropWidth, 
          cropHeight
        );
        
        // Tăng độ tương phản cho dễ đọc QR
        const contrastImage = enhanceContrast(imageData);
        
        // Sử dụng jsQR để giải mã QR code
        const code = jsQR(contrastImage.data, contrastImage.width, contrastImage.height, {
          inversionAttempts: "both",  // Thử cả hai chế độ
          canOverwriteImage: false
        });
        
        if (code) {
          console.log("✅ QR code detected:", code.data);
          scanningActive = false;
          
          // Vẽ khung xanh quanh QR để feedback trực quan
          drawQRFrame(canvasContext, code.location);
          
          processQRCode(code.data);
          return;
        }
      }
      
      // Tối ưu FPS scan: chỉ scan 15fps để giảm CPU
      if (scanningActive) {
        setTimeout(scanQRCode, 67); // ~15 FPS
      }
    }

    // Hàm tăng độ tương phản
    function enhanceContrast(imageData) {
      const data = imageData.data;
      const contrast = 1.3;
      const brightness = 10;
      
      for (let i = 0; i < data.length; i += 4) {
        // RGB contrast
        data[i] = contrast * (data[i] - 128) + 128 + brightness;
        data[i+1] = contrast * (data[i+1] - 128) + 128 + brightness;
        data[i+2] = contrast * (data[i+2] - 128) + 128 + brightness;
        
        // Clamp values
        data[i] = Math.min(255, Math.max(0, data[i]));
        data[i+1] = Math.min(255, Math.max(0, data[i+1]));
        data[i+2] = Math.min(255, Math.max(0, data[i+2]));
      }
      
      return imageData;
    }

    // Vẽ khung khi phát hiện QR
    function drawQRFrame(ctx, location) {
      ctx.strokeStyle = '#00ff00';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(location.topLeftCorner.x, location.topLeftCorner.y);
      ctx.lineTo(location.topRightCorner.x, location.topRightCorner.y);
      ctx.lineTo(location.bottomRightCorner.x, location.bottomRightCorner.y);
      ctx.lineTo(location.bottomLeftCorner.x, location.bottomLeftCorner.y);
      ctx.closePath();
      ctx.stroke();
    }

    function stopQRScanner() {
      scanningActive = false;
      
      // Xóa event listener tap-to-focus
      const videoElement = document.getElementById('videoElement');
      if (videoElement) {
        videoElement.removeEventListener('click', handleTapToFocus);
      }
      
      if (qrStream) {
        qrStream.getTracks().forEach(track => {
          track.stop();
        });
        qrStream = null;
      }
      
      if (videoElement) {
        videoElement.srcObject = null;
      }
    }

    // Chuyển đổi camera
    document.getElementById('btn-switch-camera').onclick = () => {
      currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
      startQRScanner();
    };

    // Process QR code
    async function processQRCode(decodedText) {
      if (isProcessingQR) {
        console.log("Already processing QR, ignoring...");
        return;
      }
      
      isProcessingQR = true;
      
      try {
        document.getElementById('qr-info').innerHTML = 
          '<div class="p-4 bg-yellow-900/30 text-yellow-300 rounded-lg">⏳ Đang xử lý QR code...</div>';

        const res = await fetch("/scan_qr_image", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ 
            qr_text: decodedText
          })
        });

        const result = await res.json();
        handleQRResult(result);
        
      } catch (error) {
        console.error("Error processing QR:", error);
        showQRScanError("Lỗi kết nối server", true);
      } finally {
        isProcessingQR = false;
      }
    }

    // Hiển thị lỗi quét QR
    function showQRScanError(message, reloadScanner = false) {
      document.getElementById('qr-info').innerHTML = 
        `<div class="p-4 bg-red-900/30 text-red-300 rounded-lg">❌ ${message}</div>`;
      
      if (reloadScanner) {
        setTimeout(() => {
          console.log("Tự động reload scanner...");
          startQRScanner();
        }, 3000);
      }
    }

    // ---------------------
    // HANDLE QR RESULT
    // ---------------------
    function handleQRResult(result) {
      if (!result.ok) {
        let errorMsg = result.msg || "Không đọc được QR code";
        
        if (result.reload) {
          scanRetryCount++;
          
          if (scanRetryCount <= MAX_RETRIES) {
            document.getElementById('qr-info').innerHTML = 
              `<div class="p-4 bg-yellow-900/30 text-yellow-300 rounded-lg">
                ⚠️ ${errorMsg}<br>
                <small>Tự động thử lại lần ${scanRetryCount}/${MAX_RETRIES}...</small>
              </div>`;
            
            setTimeout(() => {
              startQRScanner();
            }, 1000);
          } else {
            showQRScanError("Không thể đọc QR sau nhiều lần thử", true);
            scanRetryCount = 0;
          }
        } else {
          showQRScanError(errorMsg, false);
        }
        return;
      }

      // Reset retry count khi thành công
      scanRetryCount = 0;
      parsedQR = result.data;

      // Display QR data
      document.getElementById('qr-data').innerHTML = `
        <div class="grid grid-cols-2 gap-3">
          <div><b class="text-slate-300">CCCD mới:</b></div>
          <div class="font-mono text-blue-400">${parsedQR.cccd_moi || 'N/A'}</div>
          
          <div><b class="text-slate-300">CMND cũ:</b></div>
          <div>${parsedQR.cmnd_cu || 'N/A'}</div>
          
          <div><b class="text-slate-300">Tên:</b></div>
          <div class="font-semibold text-white">${parsedQR.name || 'N/A'}</div>
          
          <div><b class="text-slate-300">Ngày sinh:</b></div>
          <div>${parsedQR.dob || 'N/A'}</div>
          
          <div><b class="text-slate-300">Giới tính:</b></div>
          <div>${parsedQR.gender || 'N/A'}</div>
          
          <div><b class="text-slate-300">Địa chỉ:</b></div>
          <div class="col-span-1">${parsedQR.address || 'N/A'}</div>
          
          <div><b class="text-slate-300">Ngày cấp:</b></div>
          <div>${parsedQR.issue_date || 'N/A'}</div>
        </div>
        <div class="mt-4 p-3 rounded-lg ${result.duplicate ? 'bg-red-900/30 text-red-300' : 'bg-green-900/30 text-green-300'}">
          ${result.duplicate ? '⚠️ CCCD đã tồn tại trong hệ thống' : '✅ Hợp lệ – chưa tồn tại'}
        </div>
      `;

      // Switch to capture section
      showSection('capture-section');
      startCameraCapture();
    }

    // ---------------------
    // CAMERA CAPTURE (giữ nguyên)
    // ---------------------
    async function startCameraCapture() {
      stopCaptureCamera();
      
      try {
        const constraints = {
          video: { 
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        };

        stream = await navigator.mediaDevices.getUserMedia(constraints);
        
        const videoElem = document.getElementById('video');
        videoElem.srcObject = stream;
        
        // Áp dụng zoom CSS
        videoElem.style.transform = 'scale(1.5)';
        videoElem.style.transformOrigin = 'center';
        
        document.getElementById('save-status').textContent = "Camera đã sẵn sàng (Zoom 1.5x). Đưa CCCD vào khung cam.";
        document.getElementById('save-status').className = "text-green-400";
        
      } catch (error) {
        console.error("Camera error:", error);
        document.getElementById('save-status').textContent = "Lỗi: Không thể truy cập camera phía sau. Vui lòng kiểm tra quyền camera.";
        document.getElementById('save-status').className = "text-red-400";
      }
    }

    function stopCaptureCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
    }

    function stopAllCameras() {
      stopQRScanner();
      stopCaptureCamera();
    }

    // Capture snapshot
    function snap() {
      const video = document.getElementById('video');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL('image/jpeg', 0.9);
    }

    // ---------------------
    // CAPTURE BUTTONS
    // ---------------------
    document.getElementById('btn-front').onclick = async () => {
      if (!parsedQR) {
        alert("Vui lòng quét QR trước");
        return;
      }

      try {
        frontImg = snap();
        document.getElementById('preview-front').src = frontImg;

        const formData = new FormData();
        formData.append("cccd", parsedQR.cccd_moi);
        formData.append("image", frontImg);

        const res = await fetch("/save_front_image", {
          method: "POST",
          body: formData
        });

        const result = await res.json();
        const status = document.getElementById('save-status');
        
        if (result.ok) {
          status.textContent = "✅ Đã lưu ảnh mặt trước" + (result.face ? " (có ảnh khuôn mặt)" : "");
          status.className = "text-green-400";
        } else {
          status.textContent = "❌ Lỗi: " + (result.error || "Unknown");
          status.className = "text-red-400";
        }
      } catch (error) {
        console.error("Error saving front image:", error);
        document.getElementById('save-status').textContent = "❌ Lỗi kết nối server";
        document.getElementById('save-status').className = "text-red-400";
      }
    };

    document.getElementById('btn-back').onclick = async () => {
      if (!parsedQR) {
        alert("Vui lòng quét QR trước");
        return;
      }

      try {
        backImg = snap();
        document.getElementById('preview-back').src = backImg;

        const formData = new FormData();
        formData.append("cccd", parsedQR.cccd_moi);
        formData.append("image", backImg);

        const res = await fetch("/save_back_image", {
          method: "POST",
          body: formData
        });

        const result = await res.json();
        const status = document.getElementById('save-status');
        
        if (result.ok) {
          status.textContent = "✅ Đã lưu ảnh mặt sau";
          status.className = "text-green-400";
        } else {
          status.textContent = "❌ Lỗi: " + (result.error || "Unknown");
          status.className = "text-red-400";
        }
      } catch (error) {
        console.error("Error saving back image:", error);
        document.getElementById('save-status').textContent = "❌ Lỗi kết nối server";
        document.getElementById('save-status').className = "text-red-400";
      }
    };

    // ---------------------
    // SAVE RECORD
    // ---------------------
    document.getElementById('btn-save-info').onclick = async () => {
      if (!currentUser) {
        alert("Vui lòng đăng nhập trước");
        return;
      }

      if (!parsedQR) {
        alert("Vui lòng quét QR code trước");
        return;
      }

      if (!frontImg || !backImg) {
        alert("Vui lòng chụp đầy đủ ảnh mặt trước và mặt sau");
        return;
      }

      const phoneInput = document.getElementById('input-phone');
      const phone = phoneInput.value.trim();
      
      if (!phone) {
        alert("Vui lòng nhập số điện thoại");
        phoneInput.focus();
        return;
      }
      
      const phoneRegex = /^[0-9]{10,11}$/;
      if (!phoneRegex.test(phone)) {
        alert("Số điện thoại không hợp lệ. Vui lòng nhập 10-11 chữ số");
        phoneInput.focus();
        return;
      }

      const saveStatus = document.getElementById('save-status');
      saveStatus.textContent = "⏳ Đang lưu thông tin...";
      saveStatus.className = "text-yellow-400";

      try {
        const payload = {
          ...parsedQR,
          phone: phone,
          user: currentUser
        };

        const res = await fetch("/save_cccd_record", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload)
        });

        const result = await res.json();

        if (result.ok) {
          saveStatus.textContent = "✅ Lưu thông tin thành công!";
          saveStatus.className = "text-green-400";
          
          setTimeout(() => {
            alert("Lưu thông tin thành công!");
            resetCaptureForm();
            showSection('view-section');
            loadRecords(currentUser);
          }, 2000);
          
        } else {
          saveStatus.textContent = "❌ Lỗi: " + (result.error || "Unknown");
          saveStatus.className = "text-red-400";
        }
      } catch (error) {
        console.error("Error saving record:", error);
        saveStatus.textContent = "❌ Lỗi kết nối server";
        saveStatus.className = "text-red-400";
      }
    };

    // ---------------------
    // RESET
    // ---------------------
    document.getElementById('btn-reset').onclick = () => {
      resetCaptureForm();
      showSection('scan-section');
      startQRScanner();
    };

    function resetCaptureForm() {
      stopAllCameras();
      parsedQR = null;
      frontImg = null;
      backImg = null;
      
      document.getElementById('qr-data').innerHTML = '';
      document.getElementById('preview-front').src = '';
      document.getElementById('preview-back').src = '';
      document.getElementById('input-phone').value = '';
      document.getElementById('save-status').textContent = '';
    }

    // ---------------------
    // VIEW RECORDS
    // ---------------------
    document.getElementById('btn-load-records').onclick = () => {
      const username = document.getElementById('view-username').value.trim();
      if (username) {
        loadRecords(username);
      }
    };

    async function loadRecords(username) {
      const recordsArea = document.getElementById('records-area');
      const recordsStats = document.getElementById('records-stats');
      
      recordsArea.innerHTML = '<div class="text-center p-8 text-slate-400">Đang tải dữ liệu...</div>';
      
      try {
        const res = await fetch(`/records/${encodeURIComponent(username)}`);
        const result = await res.json();

        if (!result.ok) {
          recordsArea.innerHTML = `<div class="p-4 bg-red-900/30 text-red-300 rounded-lg">❌ Lỗi: ${result.error || "Không thể tải dữ liệu"}</div>`;
          recordsStats.innerHTML = '';
          return;
        }

        const records = result.records;

        if (!records || records.length === 0) {
          recordsArea.innerHTML = `<div class="text-center p-8 text-slate-400">Không có bản ghi nào cho user: ${username}</div>`;
          recordsStats.innerHTML = '';
          return;
        }

        let html = `
          <div class="overflow-x-auto rounded-lg border border-slate-700">
            <table class="w-full">
              <thead class="bg-slate-800">
                <tr>
                  <th class="p-3 text-left text-slate-300 font-medium">CCCD</th>
                  <th class="p-3 text-left text-slate-300 font-medium">Tên</th>
                  <th class="p-3 text-left text-slate-300 font-medium">Ngày sinh</th>
                  <th class="p-3 text-left text-slate-300 font-medium">Số ĐT</th>
                  <th class="p-3 text-left text-slate-300 font-medium">Ảnh</th>
                  <th class="p-3 text-left text-slate-300 font-medium">Thời gian</th>
                </tr>
              </thead>
              <tbody>
        `;

        records.forEach((r, index) => {
          const rowClass = index % 2 === 0 ? 'bg-slate-800/50' : 'bg-slate-900/50';
          
          let imgs = `
            <div class="flex gap-2">
              <a href="/images/${r.front_image}" target="_blank" 
                 class="px-2 py-1 bg-blue-900/30 hover:bg-blue-900/50 rounded text-xs transition-colors">
                Front
              </a>
          `;
          
          if (r.face_cropped) {
            imgs += `
              <a href="/images/${r.face_cropped}" target="_blank"
                 class="px-2 py-1 bg-green-900/30 hover:bg-green-900/50 rounded text-xs transition-colors">
                Face
              </a>
            `;
          }
          
          imgs += '</div>';

          html += `
            <tr class="${rowClass}">
              <td class="p-3 border-t border-slate-700 font-mono text-sm">${r.cccd_moi || 'N/A'}</td>
              <td class="p-3 border-t border-slate-700">${r.name || 'N/A'}</td>
              <td class="p-3 border-t border-slate-700">${r.dob || 'N/A'}</td>
              <td class="p-3 border-t border-slate-700">${r.phone || 'N/A'}</td>
              <td class="p-3 border-t border-slate-700">${imgs}</td>
              <td class="p-3 border-t border-slate-700 text-xs text-slate-400">
                ${r.created_at ? r.created_at.split('T')[0] : 'N/A'}
              </td>
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>
          </div>
        `;

        recordsArea.innerHTML = html;
        recordsStats.innerHTML = `<p class="text-sm">Tổng số bản ghi: <span class="font-bold text-blue-400">${records.length}</span></p>`;

      } catch (error) {
        console.error("Error fetching records:", error);
        recordsArea.innerHTML = '<div class="p-4 bg-red-900/30 text-red-300 rounded-lg">❌ Lỗi kết nối server</div>';
        recordsStats.innerHTML = '';
      }
    }
    // ---------------------
    // DEBUG MODE
    // ---------------------
    // Thêm checkbox debug vào HTML nếu muốn
    // <label class="flex items-center mt-2"><input type="checkbox" id="debug-mode" class="mr-2"> Debug Mode</label>
    
    // Khởi tạo debug mode
    const debugCheckbox = document.getElementById('debug-mode');
    if (debugCheckbox) {
      debugCheckbox.addEventListener('change', (e) => {
        debugMode = e.target.checked;
      });
    }

    // Initial load
    loadRecords(currentUser);

    // Cleanup
    window.addEventListener('beforeunload', stopAllCameras);
  </script>
</body>
</html>
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR CCCD Scanner</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- jsQR Library -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  
  <style>
    body {
      background: linear-gradient(180deg,#0f172a,#07103a);
      color: #e6eef8;
      min-height: 100vh;
    }
    
    /* Overlay styles */
    .camera-overlay {
      position: relative;
      width: 100%;
      height: 400px;
      overflow: hidden;
      border-radius: 12px;
      background: #000;
    }
    
    .scan-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: 200px;
      border: 3px solid #10b981;
      border-radius: 8px;
      z-index: 10;
      pointer-events: none;
    }
    
    /* Hiệu ứng scan line */
    .scan-frame::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, transparent, #10b981, transparent);
      animation: scanLine 2s linear infinite;
    }
    
    @keyframes scanLine {
      0% { top: 0; }
      100% { top: 100%; }
    }
    
    /* ZOOM 2x cho video QR */
    #videoElement {
      width: 200%;  /* Zoom x2 bằng cách tăng kích thước */
      height: 200%;
      object-fit: cover;
      position: absolute;
      left: -50%;   /* Căn giữa khi zoom 2x */
      top: -50%;
      transform: none !important; /* Ghi đè transform từ JS nếu có */
    }
    
    .capture-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 280px;
      height: 180px;
      border: 3px solid #f59e0b;
      border-radius: 8px;
      z-index: 10;
      pointer-events: none;
    }
    
    .hidden {
      display: none !important;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      backdrop-filter: blur(10px);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3);
    }
    
    /* Thông báo zoom */
    .zoom-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: #10b981;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 20;
      font-weight: bold;
    }
  </style>
</head>
<body class="p-4">
  <!-- Header -->
  <header class="mb-6">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold text-white">QR CCCD Scanner</h1>
        <p class="text-slate-400">Chào mừng, <span class="font-medium text-blue-400">{{ username }}</span></p>
      </div>
      <button id="btn-logout" class="btn-danger">
        Đăng xuất
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left Panel - Menu -->
    <div class="lg:col-span-1">
      <div class="card p-6">
        <h2 class="text-xl font-semibold text-white mb-4">Chức năng</h2>
        <div class="space-y-3">
          <button id="btn-scan-qr" class="w-full btn-primary">
            <div class="flex items-center justify-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
              </svg>
              Quét QR CCCD (Zoom 2x)
            </div>
          </button>
          
          <button id="btn-view-records" class="w-full btn-success">
            <div class="flex items-center justify-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
              Xem danh sách
            </div>
          </button>
          
          <div class="pt-4 mt-4 border-t border-slate-700">
            <h3 class="text-sm font-medium text-slate-300 mb-2">Hướng dẫn</h3>
            <ul class="text-sm text-slate-400 space-y-2">
              <li>1. Chọn "Quét QR CCCD"</li>
              <li>2. Đưa QR code vào khung xanh (Zoom 2x)</li>
              <li>3. Camera sẽ tự động nhận diện QR</li>
              <li>4. Chụp ảnh mặt trước/sau CCCD</li>
              <li>5. Nhập số điện thoại và lưu</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel - Content -->
    <div class="lg:col-span-2">
      <!-- QR Scanning Section -->
      <div id="scan-section" class="hidden">
        <div class="card p-6">
          <h2 class="text-xl font-semibold text-white mb-4">
            Quét QR CCCD <span class="text-green-400 text-sm">(Zoom 2x)</span>
          </h2>
          
          <div id="camera-check" class="mb-4 p-4 bg-yellow-900/30 text-yellow-300 rounded-lg hidden">
            <p class="font-semibold">⚠️ Yêu cầu quyền truy cập camera</p>
            <p class="text-sm mt-1">Vui lòng cho phép truy cập camera để sử dụng tính năng quét QR</p>
            <button id="btn-enable-camera" class="mt-2 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg">
              Cho phép camera
            </button>
          </div>
          
          <div class="camera-overlay mb-4">
            <video id="videoElement" autoplay playsinline></video>
            <div class="scan-frame"></div>
            <div class="zoom-indicator">ZOOM 2x</div>
          </div>
          
          <div id="qr-info" class="text-sm text-slate-200 mb-4"></div>
          
          <!-- Camera Status -->
          <div id="camera-status" class="p-3 bg-blue-900/30 text-blue-300 rounded-lg hidden">
            <div class="flex items-center">
              <div class="w-3 h-3 bg-green-500 rounded-full mr-2 animate-pulse"></div>
              <span>Camera đang hoạt động (Zoom 2x)</span>
            </div>
          </div>
          
          <div class="mt-4 flex gap-3 justify-center">
            <button id="btn-switch-camera" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors text-sm">
              Chuyển camera
            </button>
            <button id="btn-test-qr" class="px-4 py-2 bg-purple-700 hover:bg-purple-600 rounded-lg transition-colors text-sm hidden">
              Test QR
            </button>
          </div>
        </div>
      </div>

      <!-- Capture Section -->
      <div id="capture-section" class="hidden">
        <div class="card p-6">
          <h2 class="text-xl font-semibold text-white mb-4">Chụp ảnh CCCD</h2>
          
          <div class="mb-6">
            <div id="qr-data" class="bg-slate-800 p-4 rounded-lg"></div>
          </div>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Camera Capture -->
            <div>
              <div class="camera-overlay h-64 mb-4">
                <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
                <div class="capture-frame"></div>
              </div>
              
              <div class="grid grid-cols-2 gap-3">
                <button id="btn-front" class="btn-warning">
                  Chụp mặt trước
                </button>
                <button id="btn-back" class="btn-danger">
                  Chụp mặt sau
                </button>
              </div>
            </div>
            
            <!-- Image Previews -->
            <div class="space-y-4">
              <div>
                <h3 class="text-sm font-medium text-slate-300 mb-2">Ảnh mặt trước</h3>
                <img id="preview-front" class="w-full h-40 bg-slate-800 rounded-lg object-contain border border-slate-700">
              </div>
              
              <div>
                <h3 class="text-sm font-medium text-slate-300 mb-2">Ảnh mặt sau</h3>
                <img id="preview-back" class="w-full h-40 bg-slate-800 rounded-lg object-contain border border-slate-700">
              </div>
            </div>
          </div>
          
          <!-- Phone Input -->
          <div class="mt-6">
            <label class="block text-sm font-medium text-slate-300 mb-2">Số điện thoại</label>
            <input id="input-phone" type="tel" 
                   class="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="Nhập số điện thoại (bắt buộc)">
            <p class="text-xs text-slate-400 mt-1">Ví dụ: 0912345678</p>
          </div>
          
          <!-- Action Buttons -->
          <div class="flex gap-3 mt-6">
            <button id="btn-save-info" class="flex-1 btn-success">
              Lưu thông tin
            </button>
            <button id="btn-reset" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors">
              Làm lại
            </button>
          </div>
          
          <p id="save-status" class="mt-4 text-center text-sm"></p>
        </div>
      </div>

      <!-- View Records Section -->
      <div id="view-section" class="hidden">
        <div class="card p-6">
          <h2 class="text-xl font-semibold text-white mb-4">Danh sách bản ghi</h2>
          
          <div class="mb-6">
            <div class="flex gap-3">
              <input id="view-username" 
                     class="flex-1 p-3 rounded-lg bg-slate-800 border border-slate-700 text-white"
                     placeholder="Nhập username..." value="{{ username }}">
              <button id="btn-load-records" class="btn-primary">
                Tải dữ liệu
              </button>
            </div>
          </div>
          
          <div id="records-area" class="text-sm text-slate-200"></div>
          
          <div id="records-stats" class="mt-4 text-center text-slate-400"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ========== SIMPLE VERSION WITH ZOOM 2x ==========
    
    let currentUser = "{{ username }}";
    let parsedQR = null;
    let frontImg = null;
    let backImg = null;
    let qrStream = null;
    let captureStream = null;
    let scanningActive = false;
    let currentCamera = 'environment';
    let canvas = null;
    let canvasContext = null;
    let isZoomed = true; // Mặc định bật zoom 2x

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', function() {
      // Kiểm tra camera support
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showCameraError();
      } else {
        // Tạo canvas cho QR scanning
        canvas = document.createElement('canvas');
        canvasContext = canvas.getContext('2d', { willReadFrequently: true });
      }
      
      // Load records on page load
      loadRecords(currentUser);
    });

    // ========== LOGOUT ==========
    document.getElementById('btn-logout').onclick = () => {
      if (confirm('Bạn có chắc muốn đăng xuất?')) {
        window.location.href = '/logout';
      }
    };

    // ========== NAVIGATION ==========
    document.getElementById('btn-scan-qr').onclick = () => {
      showSection('scan-section');
      startQRScanner();
    };

    document.getElementById('btn-view-records').onclick = () => {
      showSection('view-section');
      stopAllCameras();
      loadRecords(currentUser);
    };

    function showSection(sectionId) {
      // Hide all
      ['scan-section', 'capture-section', 'view-section'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
      });
      
      // Show selected
      document.getElementById(sectionId).classList.remove('hidden');
      
      // Stop cameras if not needed
      if (sectionId !== 'scan-section') {
        stopQRScanner();
      }
      if (sectionId !== 'capture-section') {
        stopCaptureCamera();
      }
    }

    // ========== QR SCANNER VỚI ZOOM 2x ==========
    async function startQRScanner() {
      try {
        document.getElementById('qr-info').innerHTML = 
          '<div class="p-3 bg-blue-900/30 text-blue-300 rounded-lg">⏳ Đang khởi động camera với ZOOM 2x...</div>';
        
        document.getElementById('camera-status').classList.remove('hidden');
        
        // Stop previous stream
        stopQRScanner();
        
        // Get camera stream với chất lượng cao cho zoom
        const constraints = {
          video: {
            facingMode: currentCamera,
            width: { ideal: 1920, min: 1280 },  // Độ phân giải cao
            height: { ideal: 1080, min: 720 },
            frameRate: { ideal: 30, min: 24 }
          },
          audio: false
        };
        
        qrStream = await navigator.mediaDevices.getUserMedia(constraints);
        const videoElement = document.getElementById('videoElement');
        videoElement.srcObject = qrStream;
        
        // Wait for video to be ready
        await new Promise((resolve) => {
          if (videoElement.readyState >= 3) {
            resolve();
          } else {
            videoElement.onloadeddata = resolve;
            setTimeout(resolve, 1000);
          }
        });
        
        // Áp dụng zoom 2x bằng CSS
        applyZoom2x(videoElement);
        
        // Hide permission request
        document.getElementById('camera-check').classList.add('hidden');
        
        // Start scanning với xử lý ảnh nâng cao
        scanningActive = true;
        scanQRCode();
        
        document.getElementById('qr-info').innerHTML = 
          '<div class="p-3 bg-green-900/30 text-green-300 rounded-lg">✅ Camera đã sẵn sàng (ZOOM 2x). Đưa QR code CCCD vào khung xanh.</div>';
        
      } catch (error) {
        console.error('Camera error:', error);
        document.getElementById('qr-info').innerHTML = 
          `<div class="p-3 bg-red-900/30 text-red-300 rounded-lg">❌ Lỗi camera: ${error.message}</div>`;
        document.getElementById('camera-check').classList.remove('hidden');
      }
    }

    // Áp dụng zoom 2x cho video
    function applyZoom2x(videoElement) {
      // CSS đã được định nghĩa: width: 200%, height: 200%, left: -50%, top: -50%
      // Đảm bảo không có transform nào ghi đè
      videoElement.style.transform = 'none';
      videoElement.style.width = '200%';
      videoElement.style.height = '200%';
      videoElement.style.left = '-50%';
      videoElement.style.top = '-50%';
      videoElement.style.position = 'absolute';
      videoElement.style.objectFit = 'cover';
    }

    // Hàm xử lý ảnh để tăng độ tương phản cho QR dễ đọc
    function enhanceImageForQR(imageData) {
      const data = imageData.data;
      const length = data.length;
      
      // Tăng độ tương phản
      const contrast = 1.5;
      const brightness = 20;
      
      for (let i = 0; i < length; i += 4) {
        // RGB
        data[i] = contrast * (data[i] - 128) + 128 + brightness;   // R
        data[i + 1] = contrast * (data[i + 1] - 128) + 128 + brightness; // G
        data[i + 2] = contrast * (data[i + 2] - 128) + 128 + brightness; // B
        
        // Clamp values
        data[i] = Math.min(255, Math.max(0, data[i]));
        data[i + 1] = Math.min(255, Math.max(0, data[i + 1]));
        data[i + 2] = Math.min(255, Math.max(0, data[i + 2]));
      }
      
      return imageData;
    }

    function scanQRCode() {
      if (!scanningActive || !qrStream) return;
      
      const videoElement = document.getElementById('videoElement');
      
      if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
        // Set canvas size to video size
        canvas.width = videoElement.videoWidth;
        canvas.height = videoElement.videoHeight;
        
        // Vì đang zoom 2x, chúng ta sẽ crop phần trung tâm (vùng khung scan)
        // Tính toán vùng crop: lấy 50% ở giữa (tương ứng với zoom 2x)
        const cropWidth = canvas.width / 2;
        const cropHeight = canvas.height / 2;
        const cropX = (canvas.width - cropWidth) / 2;
        const cropY = (canvas.height - cropHeight) / 2;
        
        // Draw video frame to canvas (chỉ vùng crop)
        canvasContext.drawImage(videoElement, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
        
        // Get image data từ vùng đã crop
        const imageData = canvasContext.getImageData(0, 0, cropWidth, cropHeight);
        
        // Tăng cường chất lượng ảnh để dễ đọc QR
        const enhancedImage = enhanceImageForQR(imageData);
        
        // Try to decode QR code
        try {
          const code = jsQR(enhancedImage.data, enhancedImage.width, enhancedImage.height, {
            inversionAttempts: "both",  // Thử cả đảo ngược
          });
          
          if (code) {
            console.log('QR found:', code.data);
            scanningActive = false;
            
            // Hiệu ứng visual khi tìm thấy QR
            showQRDetectedEffect();
            
            processQRCode(code.data);
            return;
          }
        } catch (e) {
          console.error('jsQR error:', e);
        }
      }
      
      // Continue scanning với tốc độ 15fps (để giảm CPU)
      if (scanningActive) {
        setTimeout(scanQRCode, 66); // ~15 FPS
      }
    }

    // Hiệu ứng khi phát hiện QR
    function showQRDetectedEffect() {
      const scanFrame = document.querySelector('.scan-frame');
      scanFrame.style.borderColor = '#00ff00';
      scanFrame.style.boxShadow = '0 0 20px #00ff00';
      
      setTimeout(() => {
        scanFrame.style.borderColor = '#10b981';
        scanFrame.style.boxShadow = 'none';
      }, 1000);
    }

    function stopQRScanner() {
      scanningActive = false;
      if (qrStream) {
        qrStream.getTracks().forEach(track => track.stop());
        qrStream = null;
      }
      const videoElement = document.getElementById('videoElement');
      if (videoElement) {
        videoElement.srcObject = null;
      }
      document.getElementById('camera-status').classList.add('hidden');
    }

    // Switch camera
    document.getElementById('btn-switch-camera').onclick = () => {
      currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
      startQRScanner();
    };

    // Enable camera button
    document.getElementById('btn-enable-camera').onclick = () => {
      startQRScanner();
    };

    // ========== PROCESS QR CODE ==========
    async function processQRCode(qrText) {
      try {
        document.getElementById('qr-info').innerHTML = 
          '<div class="p-3 bg-yellow-900/30 text-yellow-300 rounded-lg">⏳ Đang xử lý QR code...</div>';
        
        // Send to server for parsing
        const response = await fetch('/scan_qr', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ qr_text: qrText })
        });
        
        const result = await response.json();
        
        if (!result.ok) {
          throw new Error(result.msg || 'Lỗi xử lý QR');
        }
        
        parsedQR = result.data;
        
        // Display QR data
        document.getElementById('qr-data').innerHTML = `
          <div class="grid grid-cols-2 gap-2">
            <div><b class="text-slate-300">CCCD mới:</b></div>
            <div class="text-blue-400 font-mono">${parsedQR.cccd_moi || 'N/A'}</div>
            
            <div><b class="text-slate-300">CMND cũ:</b></div>
            <div>${parsedQR.cmnd_cu || 'N/A'}</div>
            
            <div><b class="text-slate-300">Tên:</b></div>
            <div class="font-semibold text-white">${parsedQR.name || 'N/A'}</div>
            
            <div><b class="text-slate-300">Ngày sinh:</b></div>
            <div>${parsedQR.dob || 'N/A'}</div>
            
            <div><b class="text-slate-300">Giới tính:</b></div>
            <div>${parsedQR.gender || 'N/A'}</div>
            
            <div><b class="text-slate-300">Địa chỉ:</b></div>
            <div class="col-span-1 text-sm">${parsedQR.address || 'N/A'}</div>
          </div>
          <div class="mt-3 p-2 rounded ${result.duplicate ? 'bg-red-900/30 text-red-300' : 'bg-green-900/30 text-green-300'}">
            ${result.duplicate ? '⚠️ CCCD đã tồn tại trong hệ thống' : '✅ QR hợp lệ - chưa có trong hệ thống'}
          </div>
        `;
        
        // Switch to capture section
        showSection('capture-section');
        startCameraCapture();
        
      } catch (error) {
        console.error('QR processing error:', error);
        document.getElementById('qr-info').innerHTML = 
          `<div class="p-3 bg-red-900/30 text-red-300 rounded-lg">❌ ${error.message}</div>`;
        
        // Restart scanner after 3 seconds
        setTimeout(() => {
          scanningActive = true;
          scanQRCode();
        }, 3000);
      }
    }

    // ========== CAMERA CAPTURE (Không zoom) ==========
    async function startCameraCapture() {
      try {
        stopCaptureCamera();
        
        const constraints = {
          video: { 
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        };

        captureStream = await navigator.mediaDevices.getUserMedia(constraints);
        document.getElementById('video').srcObject = captureStream;
        
        document.getElementById('save-status').textContent = "Camera đã sẵn sàng. Đưa CCCD vào khung cam.";
        document.getElementById('save-status').className = "text-green-400";
        
      } catch (error) {
        console.error('Capture camera error:', error);
        document.getElementById('save-status').textContent = "Lỗi camera. Vui lòng cho phép truy cập camera.";
        document.getElementById('save-status').className = "text-red-400";
      }
    }

    function stopCaptureCamera() {
      if (captureStream) {
        captureStream.getTracks().forEach(track => track.stop());
        captureStream = null;
      }
    }

    function stopAllCameras() {
      stopQRScanner();
      stopCaptureCamera();
    }

    // Capture snapshot
    function snap() {
      const video = document.getElementById('video');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL('image/jpeg', 0.9);
    }

    // ========== CAPTURE BUTTONS ==========
    document.getElementById('btn-front').onclick = async () => {
      if (!parsedQR) {
        alert("Vui lòng quét QR trước");
        return;
      }

      try {
        frontImg = snap();
        document.getElementById('preview-front').src = frontImg;

        const formData = new FormData();
        formData.append("cccd", parsedQR.cccd_moi);
        formData.append("image", frontImg);

        const res = await fetch("/save_front_image", {
          method: "POST",
          body: formData
        });

        const result = await res.json();
        updateStatus(result, "mặt trước");
        
      } catch (error) {
        console.error("Error saving front image:", error);
        document.getElementById('save-status').textContent = "❌ Lỗi kết nối server";
        document.getElementById('save-status').className = "text-red-400";
      }
    };

    document.getElementById('btn-back').onclick = async () => {
      if (!parsedQR) {
        alert("Vui lòng quét QR trước");
        return;
      }

      try {
        backImg = snap();
        document.getElementById('preview-back').src = backImg;

        const formData = new FormData();
        formData.append("cccd", parsedQR.cccd_moi);
        formData.append("image", backImg);

        const res = await fetch("/save_back_image", {
          method: "POST",
          body: formData
        });

        const result = await res.json();
        updateStatus(result, "mặt sau");
        
      } catch (error) {
        console.error("Error saving back image:", error);
        document.getElementById('save-status').textContent = "❌ Lỗi kết nối server";
        document.getElementById('save-status').className = "text-red-400";
      }
    };

    function updateStatus(result, imageType) {
      const status = document.getElementById('save-status');
      if (result.ok) {
        status.textContent = `✅ Đã lưu ảnh ${imageType}` + (result.face ? " (có ảnh khuôn mặt)" : "");
        status.className = "text-green-400";
      } else {
        status.textContent = `❌ Lỗi: ${result.error || "Không xác định"}`;
        status.className = "text-red-400";
      }
    }

    // ========== SAVE RECORD ==========
    document.getElementById('btn-save-info').onclick = async () => {
      if (!currentUser) {
        alert("Vui lòng đăng nhập trước");
        return;
      }

      if (!parsedQR) {
        alert("Vui lòng quét QR code trước");
        return;
      }

      if (!frontImg || !backImg) {
        alert("Vui lòng chụp đầy đủ ảnh mặt trước và mặt sau");
        return;
      }

      const phoneInput = document.getElementById('input-phone');
      const phone = phoneInput.value.trim();
      
      if (!phone) {
        alert("Vui lòng nhập số điện thoại");
        phoneInput.focus();
        return;
      }
      
      const phoneRegex = /^[0-9]{10,11}$/;
      if (!phoneRegex.test(phone)) {
        alert("Số điện thoại không hợp lệ. Vui lòng nhập 10-11 chữ số");
        phoneInput.focus();
        return;
      }

      const saveStatus = document.getElementById('save-status');
      saveStatus.textContent = "⏳ Đang lưu thông tin...";
      saveStatus.className = "text-yellow-400";

      try {
        const payload = {
          ...parsedQR,
          phone: phone,
          user: currentUser
        };

        const res = await fetch("/save_cccd_record", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload)
        });

        const result = await res.json();

        if (result.ok) {
          saveStatus.textContent = "✅ Lưu thông tin thành công!";
          saveStatus.className = "text-green-400";
          
          setTimeout(() => {
            alert("Lưu thông tin thành công!");
            resetCaptureForm();
            showSection('view-section');
            loadRecords(currentUser);
          }, 1000);
          
        } else {
          saveStatus.textContent = "❌ Lỗi: " + (result.error || "Không xác định");
          saveStatus.className = "text-red-400";
        }
      } catch (error) {
        console.error("Error saving record:", error);
        saveStatus.textContent = "❌ Lỗi kết nối server";
        saveStatus.className = "text-red-400";
      }
    };

    // ========== RESET ==========
    document.getElementById('btn-reset').onclick = () => {
      resetCaptureForm();
      showSection('scan-section');
      startQRScanner();
    };

    function resetCaptureForm() {
      stopAllCameras();
      parsedQR = null;
      frontImg = null;
      backImg = null;
      
      document.getElementById('qr-data').innerHTML = '';
      document.getElementById('preview-front').src = '';
      document.getElementById('preview-back').src = '';
      document.getElementById('input-phone').value = '';
      document.getElementById('save-status').textContent = '';
    }

    // ========== VIEW RECORDS ==========
    document.getElementById('btn-load-records').onclick = () => {
      const username = document.getElementById('view-username').value.trim();
      if (username) {
        loadRecords(username);
      }
    };

    async function loadRecords(username) {
      const recordsArea = document.getElementById('records-area');
      const recordsStats = document.getElementById('records-stats');
      
      recordsArea.innerHTML = '<div class="text-center p-8 text-slate-400">Đang tải dữ liệu...</div>';
      
      try {
        const res = await fetch(`/records/${encodeURIComponent(username)}`);
        const result = await res.json();

        if (!result.ok) {
          recordsArea.innerHTML = `<div class="p-4 bg-red-900/30 text-red-300 rounded-lg">❌ Lỗi: ${result.error || "Không thể tải dữ liệu"}</div>`;
          recordsStats.innerHTML = '';
          return;
        }

        const records = result.records;

        if (!records || records.length === 0) {
          recordsArea.innerHTML = `<div class="text-center p-8 text-slate-400">Không có bản ghi nào cho user: ${username}</div>`;
          recordsStats.innerHTML = '';
          return;
        }

        let html = `
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-slate-800">
                <tr>
                  <th class="p-3 text-left text-slate-300">CCCD</th>
                  <th class="p-3 text-left text-slate-300">Tên</th>
                  <th class="p-3 text-left text-slate-300">Ngày sinh</th>
                  <th class="p-3 text-left text-slate-300">Số ĐT</th>
                  <th class="p-3 text-left text-slate-300">Ảnh</th>
                  <th class="p-3 text-left text-slate-300">Thời gian</th>
                </tr>
              </thead>
              <tbody>
        `;

        records.forEach((r, index) => {
          const rowClass = index % 2 === 0 ? 'bg-slate-800/50' : 'bg-slate-900/50';
          
          let imgs = `
            <div class="flex flex-wrap gap-1">
              <a href="/images/${r.front_image}" target="_blank" 
                 class="px-2 py-1 bg-blue-900/30 hover:bg-blue-900/50 rounded text-xs">
                Mặt trước
              </a>
          `;
          
          if (r.back_image) {
            imgs += `
              <a href="/images/${r.back_image}" target="_blank"
                 class="px-2 py-1 bg-purple-900/30 hover:bg-purple-900/50 rounded text-xs">
                Mặt sau
              </a>
            `;
          }
          
          if (r.face_cropped) {
            imgs += `
              <a href="/images/${r.face_cropped}" target="_blank"
                 class="px-2 py-1 bg-green-900/30 hover:bg-green-900/50 rounded text-xs">
                Khuôn mặt
              </a>
            `;
          }
          
          imgs += '</div>';

          html += `
            <tr class="${rowClass}">
              <td class="p-3 border-t border-slate-700 text-sm font-mono">${r.cccd_moi || 'N/A'}</td>
              <td class="p-3 border-t border-slate-700">${r.name || 'N/A'}</td>
              <td class="p-3 border-t border-slate-700">${r.dob || 'N/A'}</td>
              <td class="p-3 border-t border-slate-700">${r.phone || 'N/A'}</td>
              <td class="p-3 border-t border-slate-700">${imgs}</td>
              <td class="p-3 border-t border-slate-700 text-xs text-slate-400">
                ${r.created_at ? r.created_at.split('T')[0] : 'N/A'}
              </td>
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>
          </div>
        `;

        recordsArea.innerHTML = html;
        recordsStats.innerHTML = `<p class="text-sm">Tổng số bản ghi: <span class="font-bold text-blue-400">${records.length}</span></p>`;

      } catch (error) {
        console.error("Error fetching records:", error);
        recordsArea.innerHTML = '<div class="p-4 bg-red-900/30 text-red-300 rounded-lg">❌ Lỗi kết nối server</div>';
        recordsStats.innerHTML = '';
      }
    }

    // ========== UTILS ==========
    function showCameraError() {
      document.getElementById('camera-check').classList.remove('hidden');
      document.getElementById('btn-scan-qr').disabled = true;
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', stopAllCameras);
    
  </script>
</body>
</html>